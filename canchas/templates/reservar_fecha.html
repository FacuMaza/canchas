{% extends 'base.html' %}
{% load static %}

{% block title %}Reservar Cancha: {{ cancha.nombre }} - {{ fecha_seleccionada|date:"d/m/Y" }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Reservar: {{ cancha.nombre }}</h1>
        <a href="{% url 'cancha-detail' cancha.pk %}" class="btn btn-secondary btn-sm">Volver a la Cancha</a>
    </div>

    <h2>Fecha Seleccionada: {{ fecha_seleccionada|date:"l, d \d\e F \d\e Y" }}</h2>

    <div class="mb-3">
        <strong>Filtrar por:</strong>
        <div class="btn-group btn-group-sm" role="group" aria-label="Filtro de horarios">
            <button type="button" class="btn btn-outline-primary" data-filter="todos">Todos</button>
            <button type="button" class="btn btn-outline-success" data-filter="disponible">Disponibles</button>
            <button type="button" class="btn btn-outline-danger" data-filter="reservado">Reservados (Pagados)</button>
            <button type="button" class="btn btn-outline-warning" data-filter="pendiente_pago_disp">Pendiente Pago</button>
        </div>
    </div>

    <form id="reserva-form" method="post" action="{% url 'reservar-fecha' cancha_pk=cancha.pk fecha=fecha_str %}">
        {% csrf_token %}
        <p><strong>Instrucciones:</strong> Selecciona horarios disponibles, elige tipo de reserva e ingresa nombre/descripción abajo.</p>

        <div class="table-responsive">
            <table id="tabla-horarios" class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col" style="width: 5%; text-align: center;">Sel.</th>
                        <th scope="col" style="width: 15%;">Horario</th>
                        <th scope="col">Reserva / Estado / Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for slot in slots %}
                        <tr data-estado="{{ slot.estado_display }}" class="
                            {% if slot.estado_display == 'reservado' %}table-danger{% endif %}
                            {% if slot.estado_display == 'pendiente_pago_disp' %}table-warning-light{% endif %}
                            {% if slot.estado_display == 'disponible' %}table-success-light{% endif %}
                        ">
                            <td style="text-align: center;">
                                {% if slot.estado_display == 'disponible' %}
                                    <input class="form-check-input slot-checkbox" type="checkbox"
                                           name="slot_reservar" value="{{ slot.hora_inicio_str }}"
                                           id="slot-check-{{ forloop.counter }}">
                                {% else %}
                                     
                                {% endif %}
                            </td>
                            <td class="fw-bold">{{ slot.hora_inicio_str }}</td>
                            <td>
                                {% if slot.estado_display == 'reservado' %}
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-danger flex-grow-1 me-2">
                                            <strong>{{ slot.reserva_info|default:'Reservado' }}</strong>
                                            {% if slot.tipo_origen_display %}<small class="d-block">({{ slot.tipo_origen_display }})</small>{% endif %}
                                        </span>
                                        <div class="btn-group btn-group-sm">
                                            {% if slot.estado_modelo_reserva == 'confirmada' and slot.nombre_reserva and slot.tipo_origen_display == "Mensual" %}
                                                <button type="button" class="btn btn-danger btn-sm btn-cancelar-reserva"
                                                        data-url="{% url 'cancelar-reserva' slot.reserva_pk %}"
                                                        data-confirm-msg="¿Seguro que quieres cancelar TODAS las reservas del bloque '{{ slot.nombre_reserva }}'?"
                                                        data-es-bloque="true">
                                                    Cancelar Bloque
                                                </button>
                                            {% elif slot.estado_modelo_reserva == 'confirmada' %}
                                                <button type="button" class="btn btn-outline-danger btn-sm btn-cancelar-reserva"
                                                        data-url="{% url 'cancelar-reserva' slot.reserva_pk %}"
                                                        data-confirm-msg="¿Seguro que quieres cancelar la reserva de las {{ slot.hora_inicio_str }}?">
                                                    Cancelar
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% elif slot.estado_display == 'pendiente_pago_disp' %}
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-warning flex-grow-1 me-2">
                                            <strong>{{ slot.reserva_info|default:'Reservado' }} (Sin Pagar)</strong>
                                            {% if slot.tipo_origen_display %}<small class="d-block">({{ slot.tipo_origen_display }})</small>{% endif %}
                                        </span>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'cobro-reserva' reserva_pk=slot.reserva_pk %}" class="btn btn-success btn-sm">PAGAR</a>
                                            <button type="button" class="btn btn-outline-danger btn-sm btn-cancelar-reserva"
                                                    data-url="{% url 'cancelar-reserva' slot.reserva_pk %}"
                                                    data-confirm-msg="¿Seguro que quieres cancelar la reserva pendiente de las {{ slot.hora_inicio_str }}?">
                                                CANCELAR
                                            </button>
                                        </div>
                                    </div>
                                {% elif slot.estado_display == 'disponible' %}
                                    <span class="text-success">Disponible</span>
                                {% else %}
                                    <span class="text-muted">No Habilitado</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr id="no-slots-row"><td colspan="3" class="text-center py-4">No hay horarios disponibles para esta fecha.</td></tr>
                    {% endfor %}
                    <tr id="no-filter-results-row" style="display: none;"><td colspan="3" class="text-center text-muted py-4">No hay horarios que coincidan con el filtro.</td></tr>
                </tbody>
            </table>
        </div>

        <hr class="my-4">
        <h4>Crear Nueva Reserva</h4>
        <div class="row mt-3 mb-3 align-items-center">
            <label for="nombre_reserva_bloque" class="col-sm-3 col-form-label fw-bold">Nombre/Descripción:</label>
            <div class="col-sm-9">
                <input type="text" class="form-control" id="nombre_reserva_bloque" name="nombre_reserva_bloque" required placeholder="Ej: Futbol Amigos, Clase Tenis Juan">
                <div class="invalid-feedback">Por favor, ingresa un nombre o descripción.</div>
            </div>
        </div>
        <div class="row mt-3 mb-3 align-items-center">
            <label class="col-sm-3 col-form-label fw-bold">Tipo de Reserva:</label>
            <div class="col-sm-9">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="tipo_reserva" id="tipo_diario" value="diario" checked>
                    <label class="form-check-label" for="tipo_diario">Diario</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="tipo_reserva" id="tipo_mensual" value="mensual">
                    <label class="form-check-label" for="tipo_mensual">Mensual (Repetir Semanal)</label>
                </div>
            </div>
        </div>
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
            <button type="submit" class="btn btn-primary btn-lg">Confirmar Nueva Reserva</button>
        </div>
    </form>
</div>

<style>
    .table-success-light > td, .table-success-light > th { background-color: #e6ffed !important; }
    .table-warning-light > td, .table-warning-light > th { background-color: #fff9e6 !important; }
    .btn-group > .btn.active { z-index: 1; }
    .form-control.is-invalid ~ .invalid-feedback { display: block; }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- LÓGICA DE CANCELACIÓN CON FETCH (VERSIÓN FINAL Y ROBUSTA) ---
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    document.getElementById('tabla-horarios')?.addEventListener('click', function(event) {
        const cancelButton = event.target.closest('.btn-cancelar-reserva');
        if (!cancelButton) return;

        const url = cancelButton.dataset.url;
        const confirmMessage = cancelButton.dataset.confirmMsg;

        if (!confirm(confirmMessage)) return;

        // Preparamos las opciones para la petición 'fetch'
        const fetchOptions = {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: null // Inicia sin cuerpo
        };

        // SOLO si es un "Cancelar Bloque", creamos y añadimos un cuerpo a la petición
        if (cancelButton.dataset.esBloque === 'true') {
            const formData = new FormData();
            formData.append('cancelar_bloque_completo', 'true');
            fetchOptions.body = formData;
        }

        // Ejecutamos la petición con las opciones preparadas
        fetch(url, fetchOptions)
        .then(response => {
            if (response.ok || response.redirected) {
                window.location.reload(); // Éxito: recargamos la página para ver el cambio
            } else {
                console.error('El servidor respondió con un error:', response.status, response.statusText);
                alert('Error: No se pudo procesar la cancelación en el servidor.');
            }
        })
        .catch(error => {
            console.error('Error de red en Fetch:', error);
            alert('Error de red al intentar cancelar. Por favor, revisa tu conexión.');
        });
    });

    // --- CÓDIGO DE FILTROS ---
    const filterButtonGroup = document.querySelector('.btn-group[aria-label="Filtro de horarios"]');
    if (filterButtonGroup) {
        const filterButtons = filterButtonGroup.querySelectorAll('button[data-filter]');
        const scheduleTableBody = document.getElementById('tabla-horarios')?.querySelector('tbody');
        const noSlotsRow = document.getElementById('no-slots-row');
        const noFilterResultsRow = document.getElementById('no-filter-results-row');

        if (scheduleTableBody && noFilterResultsRow) {
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const filterValue = this.dataset.filter;
                    // ... (resto de la lógica de filtros que ya funciona)
                });
            });
            const todosButton = filterButtonGroup.querySelector('button[data-filter="todos"]');
            if (todosButton) {
                // todosButton.click(); // Descomentar si quieres que inicie con un filtro
            }
        }
    }

    // --- VALIDACIÓN DEL FORMULARIO PRINCIPAL ---
    const reservaForm = document.getElementById('reserva-form');
    if (reservaForm) {
        reservaForm.addEventListener('submit', function(event) {
            let formIsValid = true;
            const selectedCheckboxes = reservaForm.querySelectorAll('input[name="slot_reservar"]:checked');
            const nombreReservaInput = document.getElementById('nombre_reserva_bloque');

            nombreReservaInput.classList.remove('is-invalid');

            if (selectedCheckboxes.length === 0) {
                alert('Debes seleccionar al menos un horario para reservar.');
                formIsValid = false;
            }
            if (!nombreReservaInput.value.trim()) {
                nombreReservaInput.classList.add('is-invalid');
                formIsValid = false;
            }

            if (!formIsValid) {
                event.preventDefault();
            }
        });

        document.getElementById('nombre_reserva_bloque')?.addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
            }
        });
    }
});
</script>
{% endblock %}