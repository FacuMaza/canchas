{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}
{% load cancha_extras %}

{% block title %}{{ titulo_pagina|default:"Registrar Picadito" }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ titulo_pagina|default:"Registrar Nuevo Picadito" }}</h1>
    <hr>

    {% if messages %}{% for message in messages %}<div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>{% endfor %}{% endif %}

    <form method="post" id="picadito-form" action="">
        {% csrf_token %}

        <div class="mb-3 card">
            <div class="card-header fw-bold">Datos del Picadito</div>
            <div class="card-body">
                {% if form.non_field_errors %}<div class="alert alert-danger p-2">{{ form.non_field_errors }}</div>{% endif %}
                <div class="mb-3">
                    <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }}</label>
                    {{ form.nombre }}
                    {% if form.nombre.help_text %}<div class="form-text">{{ form.nombre.help_text }}</div>{% endif %}
                    {% if form.nombre.errors %}<div class="invalid-feedback d-block">{{ form.nombre.errors|join:", "}}</div>{% endif %}
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header fw-bold">Participantes</div>
            <div class="card-body">
                {{ participantes_formset.management_form }}
                {% if participantes_formset.non_form_errors %}<div class="alert alert-danger p-2"><strong>Errores generales:</strong> {{ participantes_formset.non_form_errors }}</div>{% endif %}
                <div class="table-responsive">
                    <table class="table table-sm table-bordered" id="participantes-table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 20%;">Nombre *</th>
                                <th style="width: 50%;">Items Consumidos</th>
                                <th style="width: 15%;" class="text-end">Costo Cancha ($)</th>
                                <th style="width: 15%;" class="text-center">Total / Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for form_participante in participantes_formset %}
                                {% if form_participante.non_field_errors %}<tr class="table-danger"><td colspan="4"><div class="alert alert-danger p-1 mb-0">Fila {{ forloop.counter }}: {{ form_participante.non_field_errors }}</div></td></tr>{% endif %}
                                <tr class="participante-form-row" id="participante-row-{{ forloop.counter0 }}">
                                    {% for hidden_field in form_participante.hidden_fields %}{{ hidden_field }}{% endfor %}
                                    <td class="{% if form_participante.nombre_jugador.errors %}table-danger{% endif %}">{{ form_participante.nombre_jugador }}{% if form_participante.nombre_jugador.errors %}<div class="text-danger small mt-1">{{ form_participante.nombre_jugador.errors|join:", " }}</div>{% endif %}</td>
                                    <td class="{% if form_participante.items_consumidos.errors %}table-danger{% endif %}">
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                                                Seleccionar items <span class="selected-items-count badge bg-primary rounded-pill ms-1"></span>
                                            </button>
                                            
                                            <div class="dropdown-menu p-2" data-bs-popper="static" style="min-width: 300px; max-height: 350px; overflow-y: auto;">
                                                <div class="selected-items-container mb-2"><h6 class="dropdown-header px-1 pt-1 pb-0">Seleccionados</h6></div>
                                                <hr class="my-1">
                                                <div class="all-items-container">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <h6 class="dropdown-header px-1 pt-1 pb-0 me-2 flex-grow-1">Todos los Items</h6>
                                                        <input type="search" class="form-control form-control-sm item-search-input" placeholder="Buscar..." style="width: 120px;">
                                                    </div>
                                                    {% for extra_obj in extras_activos %}
                                                        {% with extra_price=extra_obj.precio_actual|default:'0.00' %}
                                                            <div class="dropdown-item-wrapper d-flex justify-content-between align-items-center mb-1" data-extra-pk-wrapper="{{ extra_obj.pk }}">
                                                                <div class="form-check">
                                                                    <input class="form-check-input item-consumido-check" type="checkbox" name="{{ form_participante.prefix }}-items_consumidos" value="{{ extra_obj.pk }}" id="id_{{ form_participante.prefix }}-items_consumidos_{{ extra_obj.pk }}" data-price="{{ extra_price }}" data-extra-pk="{{ extra_obj.pk }}" {% with current_values=form_participante.items_consumidos.value|default:'' %}{% if extra_obj.pk|stringformat:"s" in current_values or extra_obj.pk in current_values %}checked{% endif %}{% endwith %}>
                                                                    <label class="form-check-label small" for="id_{{ form_participante.prefix }}-items_consumidos_{{ extra_obj.pk }}">{{ extra_obj.nombre }} (${{ extra_price|floatformat:2 }})</label>
                                                                </div>
                                                                <button type="button" class="btn btn-outline-warning btn-sm py-0 px-1 discount-button ms-2" data-extra-pk="{{ extra_obj.pk }}" title="Aplicar 50% de descuento">50%</button>
                                                            </div>
                                                        {% endwith %}
                                                    {% empty %}
                                                        <span class="dropdown-item-text text-muted fst-italic">No hay items extra activos.</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        {% if form_participante.items_consumidos.errors %}<div class="text-danger small mt-1">{{ form_participante.items_consumidos.errors|join:", " }}</div>{% endif %}
                                    </td>
                                    <td class="text-end {% if form_participante.costo_cancha.errors %}table-danger{% endif %}">{{ form_participante.costo_cancha }}{% if form_participante.costo_cancha.errors %}<div class="text-danger small mt-1">{{ form_participante.costo_cancha.errors|join:", " }}</div>{% endif %}</td>
                                    <td class="text-center align-middle {% if form_participante.DELETE.errors %}table-danger{% endif %}"><div class="fw-bold mb-1">Total: $<span class="participant-total">0.00</span></div>{% if form_participante.instance.pk and participantes_formset.can_delete %}<div class="form-check d-inline-block" title="Marcar para eliminar">{{ form_participante.DELETE }} <label for="{{ form_participante.DELETE.id_for_label }}" class="form-check-label small">Del</label></div>{% elif not form_participante.instance.pk %}<span class="text-muted">--</span>{% endif %}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="mt-4 d-flex justify-content-end">
            <a href="{% url 'picadito-list' %}" class="btn btn-secondary me-2">Cancelar</a>
            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Guardar Picadito y Participantes</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('participantes-table');
    if (!table) { return; }

    const originalOrderForRow = new Map();

    // --- Funciones auxiliares (Sin cambios) ---
    function updateHiddenDiscountField(row) {
        const hiddenInput = row.querySelector('input[name$="-items_con_descuento_pks"]');
        if (!hiddenInput) return;
        const discountedPks = Array.from(row.querySelectorAll('.discount-button.active')).map(btn => btn.dataset.extraPk);
        hiddenInput.value = discountedPks.join(',');
    }
    function updateDropdownButtonText(row) {
        const countSpan = row.querySelector('.selected-items-count');
        if (!countSpan) return;
        const selectedCount = row.querySelectorAll('.item-consumido-check:checked').length;
        countSpan.textContent = selectedCount > 0 ? selectedCount : '';
        countSpan.style.display = selectedCount > 0 ? 'inline-block' : 'none';
    }
    function calculateParticipantTotal(row) {
        let itemsTotal = 0;
        const costoCanchaInput = row.querySelector('input[name$="-costo_cancha"]');
        const totalDisplay = row.querySelector('.participant-total');
        const costoCancha = parseFloat(costoCanchaInput?.value.replace(',', '.')) || 0;
        row.querySelectorAll('.item-consumido-check:checked').forEach(checkbox => {
            const price = parseFloat(checkbox.dataset.price) || 0;
            const discountButton = row.querySelector(`.discount-button[data-extra-pk="${checkbox.dataset.extraPk}"]`);
            const isDiscounted = discountButton?.classList.contains('active');
            itemsTotal += isDiscounted ? (price / 2) : price;
        });
        const finalTotal = costoCancha + itemsTotal;
        if (totalDisplay) { totalDisplay.textContent = finalTotal.toFixed(2).replace('.', ','); }
    }
    function moveItem(itemWrapper, isChecked) {
        const rowId = itemWrapper.dataset.parentRowId;
        const row = document.getElementById(rowId);
        if (!row) { return; }
        const selectedContainer = row.querySelector('.selected-items-container');
        const allItemsListContainer = row.querySelector('.all-items-container');
        if (isChecked) {
            selectedContainer.appendChild(itemWrapper);
        } else {
            const originalOrder = originalOrderForRow.get(row);
            let inserted = false;
            for (const orderedItem of originalOrder) {
                const siblingInList = allItemsListContainer.querySelector(`[data-extra-pk-wrapper="${orderedItem.dataset.extraPkWrapper}"]`);
                if (siblingInList && originalOrder.indexOf(itemWrapper) < originalOrder.indexOf(orderedItem)) {
                    allItemsListContainer.insertBefore(itemWrapper, siblingInList);
                    inserted = true;
                    break;
                }
            }
            if (!inserted) { allItemsListContainer.appendChild(itemWrapper); }
        }
    }


    // =================================================================================
    // INICIO: LÓGICA DE EVENTOS
    // =================================================================================

    // --- Bucle de Inicialización ---
    table.querySelectorAll('.participante-form-row').forEach(row => {
        const rowId = row.id;
        const items = Array.from(row.querySelectorAll('.dropdown-item-wrapper'));
        items.forEach(item => { item.dataset.parentRowId = rowId; });
        originalOrderForRow.set(row, items);
        
        row.querySelectorAll('.item-consumido-check:checked').forEach(checkbox => {
            moveItem(checkbox.closest('.dropdown-item-wrapper'), true);
        });
        const hiddenDiscountInput = row.querySelector('input[name$="-items_con_descuento_pks"]');
        if (hiddenDiscountInput?.value) {
            const pks = hiddenDiscountInput.value.split(',');
            pks.forEach(pk => {
                if (!pk) return;
                const button = row.querySelector(`.discount-button[data-extra-pk="${pk}"]`);
                if (button) { button.classList.add('active', 'btn-warning'); button.classList.remove('btn-outline-warning'); }
            });
        }
        calculateParticipantTotal(row);
        updateDropdownButtonText(row);
    });

    // --- Listeners con Delegación ---

    // 1. Listener para el FILTRO DE BÚSQUEDA y Costo de Cancha
    table.addEventListener('input', function(event) {
        if (event.target.matches('.item-search-input')) {
            const searchInput = event.target;
            const row = searchInput.closest('.participante-form-row');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            row.querySelectorAll('.all-items-container .dropdown-item-wrapper').forEach(itemWrapper => {
                const label = itemWrapper.querySelector('label');
                const itemName = label ? label.textContent.toLowerCase() : '';
                
                // ==========================================================
                // ========= ESTE ES EL CAMBIO MÁS IMPORTANTE ================
                // En lugar de style.display, usamos classList para añadir/quitar la clase .d-none de Bootstrap
                if (itemName.includes(searchTerm)) {
                    itemWrapper.classList.remove('d-none');
                } else {
                    itemWrapper.classList.add('d-none');
                }
                // ==========================================================
                // ==========================================================
            });
        }
        else if (event.target.matches('input[name$="-costo_cancha"]')) {
            calculateParticipantTotal(event.target.closest('.participante-form-row'));
        }
    });

    // 2. Listener para los CLICKS (sin cambios)
    table.addEventListener('click', function(event) {
        if (event.target.closest('.dropdown-menu')) {
            event.stopPropagation();
        }
        const target = event.target;
        const row = target.closest('.participante-form-row');
        if (!row) return;

        if (target.classList.contains('discount-button')) {
            event.preventDefault();
            const checkbox = row.querySelector(`.item-consumido-check[data-extra-pk="${target.dataset.extraPk}"]`);
            if (checkbox?.checked) {
                target.classList.toggle('active');
                target.classList.toggle('btn-warning');
                target.classList.toggle('btn-outline-warning');
                updateHiddenDiscountField(row);
                calculateParticipantTotal(row);
            }
        } else if (target.classList.contains('item-consumido-check')) {
            const itemWrapper = target.closest('.dropdown-item-wrapper');
            const discountButton = itemWrapper.querySelector('.discount-button');
            if (!target.checked) {
                discountButton.classList.remove('active', 'btn-warning');
                discountButton.classList.add('btn-outline-warning');
            }
            moveItem(itemWrapper, target.checked);
            updateHiddenDiscountField(row);
            calculateParticipantTotal(row);
            updateDropdownButtonText(row);
        }
    });

    console.log("Script de Picadito inicializado (¡versión final con filtro por clase!).");
});
</script>
{% endblock %}